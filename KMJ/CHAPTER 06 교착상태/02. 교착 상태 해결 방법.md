# 교착 상태 해결 방법
## 교착 상태 해결 방법
- 교착 상태 예방 : 교착상태는 상호 배제, 비선점, 점유와 대기, 원형 대기라는 네가지 조건을 동시에 충족해야 발생하기 때문에 이 중 하나라도 무력화 되면 교착상태가 발생하지 않는다. 실효성이 적어 잘 사용되지 않는다.
- 교착 상태 회피 : 자원을 할당하다가 교착 상태를 유발할 가능성이 있다고 판단되면 자원 할당을 중단하고 지켜본다. 자원을 얼마만큼 할당해야 교착상태가 발생하지 않는다는 보장이 없기때문에 실효성이 적다.
- 교착 상태 검출 : 자원 할당 그래프를 사용하여 교착상태를 발견. 교착상태 발생시 교착 상태 회복단계가 실행된다.
- 교착 상태 회복 : 교착 상태를 검출한 후 해결하는 현실적인 접근 방법이다

------------

## 교착 상태 예방
### 상호 배제 예방
시스템 내에 있는 상호 배타적인 모든 자원, 즉 독점적으로 사용할 수 있는 자원을 없애버려 교착상태가 발생하지 않도록 한다.<br>
그러나 현실적으로는 모든 자원을 공유할 수 없으며 상호 배제를 적용하여 보호해야 하는 자원이 있다. 또한 시스템 내에는 공유할 수 없는 자원이 있다.<br>
따라서 상호 배제를 무력화 하는것은 사실상 어렵다.<br>

### 비선점 예방
모든 자원을 빼앗을수 있도록 만드는 방법이다. <br>
식사하는 철학자 문제에서 옆 사람의 포크를 빼앗을수 있다면 교착상태가 발생하지 않지만, 임계구역을 보호하기 위해 잠금을 사용하면 자원을 빼앗을수 없을 뿐만 아니라 상호배제도 보장할 수 없다. <br>
따라서 시스템의 모드 자원을 빼앗을수 있도록 하기 어려우며 빼앗을수 있더라도 어떤 기준으로 빼앗을지, 빼앗을 시간 중 얼마나 사용할지 결정하기 어렵다.<br>
또한 아사현상을 일으킨다는 문제가 있다. <br>
아사현상은 주로 에이징을 사용하여 해결하지만 우선수위가 낮은 프로세스가 몇 번을 양보한 끝에 무조건 자원을 사용한다고 가정하면 이 프로세스가 점유하고 있는 자원은 비선점 자원이되어 다시 교착상태에 빠질수 있기때문에 에이징을 사용하기 어렵고 비선점 조건을 무력화하기 어렵다.<br>

### 점유와 대기 예방
프로세스가 자원을 점유한 상태에서 다른 자원을 기다리지 못하게 하는 방법으로 "전부 할당하거나 아니면 아예 할당하지 않는" 방식을 적용하는것이다.<br>
이를 위해 프로세스는 시작 초기에 자신이 사용하려는 모든 자원을 한꺼번에 점유하거나, 그렇지 못할 경우 자원을 모두 할당해야 한다.<br>
이 방법은 식사하는 철학자 문제에서 왼쪽 포크를 잡은 상태에서 오른쪽 포크를 잡지 못하도록 막는것과 같은데, 철학자들은 식사를 시작할때 양손에 포크를 잡아야 하며 그렇게 할 수 없으면 잡았던 포크를 내려놓아야 한다.<br>
따라서 동작이 빠른 철학자가 먼저 식사를 할 수 있다.<br>

점유와 대기 예방은 다음과 같은 단점이 있다.<br>
- 프로세스가 자신이 사용하는 모든 자원을 자세히 알기 어렵다.
- 자원의 활용성이 떨어진다.
- 많은 자원을 사용하는 프로세스가 적은 자원을 사용하는 프로세스보다 불리하다.
- 결국 일괄 작업 방식으로 동작한다.
 
### 원형 대기 예방
점유와 대기를 하는 프로세스들이 원형을 이루지 못하도록 막는 방법이다. <br>
자원을 한 방향으로만 사용하도록 설정함으로써 원형 대기를 예방할 수 있다. 즉 모든 자원에 숫자를 부여하고 숫자가 큰 방향으로만 자원을 할당하는것이다.<br>
원형 대기 예방의 경우 프로세스들이 자원을 사용하려고 할때 작은 번호의 자원을 할당 받은 후 큰 번호의 자원을 할당받도록 한다.<br>
<br>
원형 대기 예방은 모든 자원을 할당받아야 실행할 수 있는 점유와 대기 예방보다 완화된 방법이지만 단점이 있다.<br>
- 프로세스 작업 진행에 유연성이 떨어진다.
- 자원의 번호를 어떻게 부여할 것인지가 문제이다.

## 교착 상태 회피
### 교착 상태 회피의 개념
교착 상태 회피는 프로세스에 자원을 할당할 때 어느 수준 이상의 자원을 나누어주면 교착상태가 발생하는지 파악하여 그 수준 이하로 자원을 나누어주는 방법이다. <br>
교착상태가 발생하지 않는 범위 내에서만 자원을 할당하고, 교착상태가 발생하는 범위에 있으면 프로세스를 대기시키다.<br>
<br>
교착상태 회피는 할당되는 자원의 수를 조절하여 교착상태를 피한다. 이느 시스템의 운영방식에 변경을 가하지 않기때문에 교착 상태 예방보다 좀 더 유연하다<br>
교착상태 회피는 자원의 총스와 현재 할당된 자원의 수를 기준으로 시스템을 안정상태와 불안정 상태로 나누고 시스템이 안정상태를 유지하도록 자원을 할당하다.<br>
하지만 불안정 상태에서 항상 교착상태가 발생하는것은 아니며 교착상태가 발생할 가능성이 높아진다.<br>

### 은행원 알고리즘
교착상태 회피를 구현하는 방법중 하나이다. <br>
대출금액이 대출 가능한 범위내이면(안정상태이면) 허용되지만 그렇지 않으면 거부되는것과 유사하기때문에 이렇게 불리게 되었다. <br>
<br>
다음은 은행원 알고리즘의 변수이다.<br>
- 전체 자원 : 시스템 내 전체 자원의 수
- 가용 자원 : 시스템 내 현재 사용할 수 있는 자원의 수(가용자원=전체자원-모든 프로세스의 할당 자원)
- 최대 자원 : 각 프로세스가 선언된 최대 자원의 수
- 할당 자원 : 각 프로세스에 현재 할당된 자원의 수
- 기대 자원 : 각 프로세스가 앞으로 사용할 자원의수(기대자원=최대자원-할당자원)

##### 자원을 할당할때의 기준
- 각 프로세스의 기대 자원과 비교하여 가용 자원이 하나라도 크거나 같으면 자원을 할당한다. 가용 자원이 기대자원보다 크다는것은 그 자원을 사용하여 작업을 끝낼수 있는 프로세스가 있다는 의미이므로 안정상태이다.
- 가용 자원이 어떤 기대 자원보다 크지 않으면 할당하지 않는다. 가용자원을 사용하여 작업을 마칠수 있는 프로세스가 없다는 의미이므로 불안정 상태이다.

##### 안정상태
각 프로세스의 기대 자원과 비교하여 가용 자원이 크거나 같은 경우가 한번 이상인 경우를 말한다.<br>
<br>
은행원 알고리즘에서는 현재 실행중인 프로세스 가운데 하나라도 끝낼수 있을때 가용자원을 할당해야 한다.

### 교착상태 회피의 문제점
- 프로세스가 자신이 사용할 모든 자원을 미리 선언해야 한다.
- 시스템의 전체 자원수가 고정적이어야 한다.
- 최대 자원을 사용하지 않고 작업을 마치는 경우도 있기때문에 자원이 낭비된다.

## 교착상태 검출
### 교착 상태 검출의 개념
운영체제가 프로세스의 작업을 관찰하면서 교착상태 발생여부를 계속 주시하는 방식이다.<br> 만약 교착상태가 발견이 되면 이를 해결하기위해 교착 상태 회복 단계를 밟는다.<br>

### 타임아웃을 이용한 교착상태 검출
일정 시간동안 작업이 진행되지 않은 프로세스를 교착상태가 발생한것으로 간주하여 처리하는 방법으로 교착상태가 자주 발생하지 않을 것이라는 가정하에 사용한다.<br>
특별한 알고리즘이 없어 쉽게 구현할 수 있다.<br>
가벼운 교착상태 검출이라고 부르고 대부분의 데이터베이스와 운영체제에서 많이 선호한다.<br>

##### 타임아웃을 이용한 교착상태 검출의 문제점
- 타임아웃을 이용하면 교착상태 외의 다른 이유로 작업이 진행되지 못하는 모든 프로세스가 강제 종료될수 있다.
- 분산 데이터 베이스의 경우에는데이터가 여러 시스템에 나뉘어져 있고 각 시스템이 네트워크로 연결되어 있기때문에 프로그램의 응답이 없는것이 네트워크 문제인지 처리가 늦어지는것인지 알수 없기때문에 모든 시스템에 적용할 수 없다.

데이터베이스에서는 데이터의 일관성이 깨지면 안되기때문에 데이터를 조작시 반드시 잠금을 얻은 후 작업을 시작한다.<br>
타임아웃으로 데이터의 일관성이 깨지는것을 막기 위해 체크포인트(check point)와 롤백(roll back)을 사용한다.<br>

- 체크포인트 : 작업을 하다가 문제 발생시 저장된 상태로 돌아오기 위한 표시. 체크포인트 설정시 현재의 시스템 상태가 하드디스크에 저장되는데 이를 스냅 숏(snap shot)이라고 한다.
- 롤백 : 작업을 하다 문제 발생시 과거의 체크포인트로 돌아가는것

### 자원 할당 그래프를 이용한 교착 상태 검출
교착 상태가 없는 자원 할당 그래프와 교착 상태가 있는 자원 할당 그래프가 있다. <br>
자원할당 그래프를 보면 시스템 내의 프로세스가 어떤 자원을 사용하고 어떤 자원을 기다리고 있는지 알 수 있다.<br>
자원 할당 그래프 안에서 사각형 안의 작은 동그라미는 동시에 사용 가능한 자원의 수를 나타내는데, 단일 자원을 사용하는 경우 자원 할당 그래프에 사이클 있으면 교착상태이다.<br>
그러나 다중 자원을 사용하는 경우에는 자원 할당 그래프에 사이클이 있다고 해서 모두 교착상태라고 판단할 수 없다. <br>
<br>
프로세스의 작업 방식을 제한하지 않으면서 교착 상태를 정확하게 파악할 수 있다는것이 장점이다. <br>
그러나 자원 할당 그래프를 유지, 갱신, 검사하는 추가작업으로 인해 오버헤드가 발생하는것이 단점이다. <br>이러한 단점을 줄이기 위해 자원이 할당될 때마다 사이클 검사를 하는것이 아니라 일정 시간마다 검사를 하기도 한다. <br>

## 교착 상태 회복
교착 상태를 유발한 프로세스를 강제로 종료한다. <br>

### 교착 상태를 일으킨 모든 프로세스를 동시에 종료
종료된 프로세스들이 동시에 작업을 다시 시작하면 다시 교착상태를 일으킬 가능성이 높기때문에 모든 프로세스를 강제로 종료한 후 다시 실행시에는 순차적으로 실행해야 한다.<br>
이때 어떤 프로세스를 먼저 실행할 것인가에대한 기준이 필요하다.<br>

### 교착 상태를 일으킨 프로세스 중 하나를 골라 순서대로 종료
프로세스를 종료할 때 어떤 프로세스부터 종료할 것인지 다음과 같은 기준이 필요하다.<br>

- 우선순위가 낮은 프로세스를 먼저 종료한다.
- 우선순위가 같은 경우 작업시간이 더 짧은 프로세스를 먼저 종료한다.
- 위의 두 조건이 같은 경우 자원을 많이 사용하는 프로세스를 먼저 종료한다.

교착상태 회복 단계에서는 관련 프로세스를 종료할 뿐만 아니라 강제 종료된 프로세스가 실행되기 전에 시스템을 복구하는 일도 해야한다.<br>
시스템 복구는 명령어가 실행될때마다 체크포인트를 만들어 가장 최근의 검사시점으로 돌아가는 식으로 한다.<br>
하지만 이 방법은 작업량이 많아 시스템에 부하를 주므로 선택적으로 사용하는것이 중요하다.<br>









