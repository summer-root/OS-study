# 프로세스의 연산

## 프로세스의 구조

프로세스는 코드 영역, 데이터 영역, 스택 영역으로 구성된다. 데이터 영역은 일반 데이터 영역과 힙 영역으로 나뉜다.

- 코드 영역 : 프로세스의 본문이 기술되어 있는 영역으로 텍스트 영역이라고도 한다. 프로그래머가 작성한 프로그램은 코드 영역에 탑재되며 탑재된 코드는 읽기 전용으로 처리된다.
- 데이터 영역 : 코드가 실행되면서 사용하는 변수나 파일 등의 각종 데이터를 모아놓은 영역이다. 데이터는 변하는 값이기 때문에 읽기와 쓰기가 가능하다.
- 스택 영역 : 코드를 작동하기 위해 운영체제가 부수적으로 관리하는 데이터를 모아놓은 영역이다. 예를 들어 프로세스 내에서 함수를 호출하면 함수를 수핸하고 원래 프로그램으로 되돌아올 위치를 해당 영역에 저장한다. 스택 영역은 운영체제가 사용자의 프로세스를 작동하기 위해 유지하는 영역이기 떄문에 사용자에게는 보이지 않는다.

<br>



## 프로세스의 생성과 복사

### fork() 시스템 호출의 개념

fork() 시스템 호출은 실행 중인 프로세스로부터 새로운 프로세스를 복사하는 함수이다. fork() 시스템 호출을 사용하면 실행 중인 프로세스와 똑같은 프로세스가 하나 더 만들어진다. 

대표적인 예로 워드 프로그램에서 작업을 하다가 새로운 워드 프로그램을 실행하는 경우 fork() 시스템 호출이 사용되어 기존의 워드 프로그램을 복사한다. 이렇게 복사하는 경우 처음 프로그램을 실행하는 속도보다 빠르다.

프로세스를 복사하면 기존의 프로세스는 부모 프로세스가 되고, 새로 생긴 프로세스는 자식 프로세스가 되어 두 프로세스가 서로 부모-자식 관계로 연결된다.

fork() 문 이전에 파일을 열거나 변수를 선언하면 이것이 모두 자식 프로세스에 상속된다.

<br>



### fork() 시스템 호출의 동작 과정

fork() 시스템 호출을 하면 프로세스 제어 블록을 포함한 부모 프로세스 영역의 대부분이 자식 프로세스에 복사되어 똑같은 프로세스가 만들어진다. 단, 다음 부분은 변경된다.

- 프로세스 구분자가 바뀐다.
- 부모 프로세스와 자식 프로세스가 차지하고 있는 메모리의 위치가 다르기 때문에 메모리 관련 정보가 바뀐다.
- 부모 프로세스 구분자와 자식 프로세스 구분자가 바뀐다.

<br>



### fork() 시스템 호출의 장점

- 하드디스크로부터 프로그램을 새로 가져오지 않고 기존 메모리에서 복사하기 때문에 프로세스의 생성 속도가 빠르다.
- 부모 프로세스가 사용하던 모든 자원을 추가 작업 없이 자식 프로세스에 상속할 수 있다.
- 프로세스를 종료하면 프로세스가 사용하던 메모리 영역, 파일, 하드웨어를 잘 정리해야 하는제 프로세스가 구분자로 연결되어 있기 때문에 자식 프로세스가 종료된 후 정리를 부모 프로세스에게 맡길 수 있다. 따라서 시스템이 효율적으로 관리된다.

<br>



## 프로세스의 전환

### exec() 시스템 호출의 개념

exec() 시스템 호출은 기존의 프로세스를 새로운 프로세스로 전환하는 함수이다. 해당 시스템 호출을 사용하는 목적은 프로세스의 구조체를 재활용하기 위함이다. 새로운 프로세스를 만들기 위해서는 프로세스 제어 블록을 만들고 메모리의 자리를 확보하는 과정이 필요하다. 또한 프로세스를 종료한 후 사용한 메모리를 청소(garbage collection)하기 위해 상위 프로세스와 부모-자식 관계를 만들어야 한다. 이때 exec() 시스템 호출을 사용하면 이미 만들어진 프로세스 제어 블록, 메모리 영역, 부모-자식 관계를 그대로 사용할 수 있고, 새로운 코드 영역만 가져오면 되기 때문에 편리하다.

<br>



### exec() 시스템 호출의 동작 과정

exec() 시스템 호출을 하면 코드 영역에 있는 기존 내용을 지우고 새로운 코드로 바꾼다. 또한 데이터 영역이 새로운 변수로 채워지고 스택 영역이 리셋된다. 각종 프로세스 구분자(PID, PPID, CPID)만 남고 프로세스의 나머지 내용들은 초기 상태로 리셋된다.

** 유닉스에서 exec() 시스템 호출은 인자에 따라 execl(), execlp(), execv(), execvp()와 같은 함수가 있다. 기능은 모두 동일하다.

<br>



## 프로세스의 계층 구조

### 유닉스의 프로세스 계층 구조

유닉스에서 커널이 처음 메모리에 올라와 부팅이 될 때 만들어지는 init 프로세스가 전체 프로세스의 출발점이 된다. 운영체제는 프로세스를 효율적으로 관리하기 위해 나머지 프로세스를 init 프로세스의 자식으로 만든다. init 프로세스의 자식으로는 login 프로세스, shell 프로세스 등이 있다.

<br>



### 프로세스 계층 구조의 장점

- 여러 작업의 동시 처리
- 자원 회수의 용이성

<br>



### 고아 프로세스

부모 프로세스가 먼저 종료되거나 자식 프로세스가 비정상적으로 종료되어 부모 프로세스에 연락이 되지 않는 경우 자식 프로세스가 종료되지 않거나, 종료 되었는데도 사용하던 자원이 그대로 남게 된다. 이처럼 프로세스가 종료된 후에도 비정상적으로 남아 있는 프로세스를 고아 프로세스 또는 좀비 프로세스라고 한다. 

고아 프로세스는 부모 프로세스가 자식 프로세스보다 먼저 종료되는 경우 발생하고, 좀비 프로세스는 자식 프로세스가 종료되었음에도 부모가 뒤처리를 하지 않을 때 발생한다. 컴퓨터에 고아나 좀비 프로세스가 많아지면 자원이 낭비되기 때문에 효율적인 운영에 방해가 된다. 따라서 운영체제는 반환되지 못한 자원을 회수하는 자원 회수를 주기적으로 해야 한다.