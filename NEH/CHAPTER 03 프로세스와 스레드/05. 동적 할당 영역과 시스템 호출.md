# 동적 할당 영역과 시스템 호출

## 프로세스의 동적 할당 영역

프로세스의 구조

- 정적 할당 영역
  - 코드 영역
  - 데이터 영역
- 동적 할당 영역
  - 스택 영역
  - 힙 영역





### 스택 영역

스택은 함수 호출 시 두 가지 작업을 구현하기 위해 사용한다.

1. 호출한 함수가 종료되어 함수를 호출하기 전 코드로 돌아올 때 알아야 하는 되돌아올 메모리의 주소 저장
2. 변수 사용 범위에 영향을 미치는 영역을 구현하는 경우 (지역 변수의 값 저장)

<br>



스택은 가장 먼저 들어간 데이터가 가장 나중에 나오는 자료구조로 스택에 데이터를 삽입하는 것을 push, 꺼내는 것을 pop이라고 한다.

스택은 프로세스를 작동하기 위해 커널이 유지하는 자료 구조이다. 스택은 스레드가 작동하는 동안 추가되거나 삭제되기 때문에 크기가 계속 변한다. 따라서 동적 할당 영역이다.

<br>



### 힙 영역

힙은 동적으로 할당되는 변수 영역이다. 일부 데이터는 프로그램이 실행되는 동안 할당되는데 대표적으로 malloc() 함수가 있다.

```c
main(){
    int sarr[50];
    int *darr;
    
    darr = (int*)malloc(sizeof(int)*50); // sizeof(int) : int의 크기 반환
    // malloc의 반환형은 void*이므로 darr에 할당하기 위해서는 int*로 형변환 필요
    
    free(darr);
}
```

위 코드에서 sarr의 경우 프로세스가 종료될 때까지 메모리를 차지하지만, darr의 경우 필요할 때 malloc() 함수로 메모리를 할당받고, 필요 없어지면 free() 함수로 할당받았던 메모리 영역을 반환한다. 이를 통해 효율적으로 메모리 관리를 할 수 있다.

<br>



#### malloc()과 calloc()의  차이

|        | malloc()                                          | calloc()                                 |
| ------ | ------------------------------------------------- | ---------------------------------------- |
| 코드   | void * malloc (size_t size);                      | void * calloc (size_t num, size_t size); |
| 초기화 | 할당된 메모리를 초기화하지 않아 쓰레기값이 들어감 | 할당된 메모리를 0으로 초기화             |
| 속도   | 빠름                                              | 느림                                     |

<br>



## exit()와 wait() 시스템 호출

### exit() 시스템 호출

작업의 종료를 알려 주는 시스템 호출이다. exit() 함수를 사용하는 경우 부모 프로세스는 자식 프로세스가 사용하던 자원을 빨리 거둬갈 수 있다. 

exit()의 인자

- 0 : 정상 종료
- -1 : 비정상 종료
- 기타 정수 숫자 : 해당 숫자를 에러 코드로 운영체제에 반환함

exit() 함수는 바로 프로세스를 종료하고, return은 뒤 문장을 실행한 후 종료한다.

<br>



#### exit()의 특징

- 종료 전 모든 열려진 파일들을 자동으로 닫는다.
- 출력 버퍼 속에 데이터가 있는 경우 그것을 쓰기 완료 시킨다.
- 주로 에러가 났을 때 강제 종료 시키기 위해 if문 안에서 사용된다.
- exit()의 입력 인자로 전달하는 status는 운영체제에 전달되며, main 함수의 return 값과 같은 역할을 한다.

<br>



### wait() 시스템 호출

부모 프로세스가 먼저 종료되어 자식 프로세스가 고아 프로세스가 되지 않도록 하기 위해 자식 프로세스가 끝날 때까지 기다리는 용도로 사용된다. 

<br>



#### wait()의 작동 방식

1. 자식 프로세스가 동작 중이면 상태를 얻어올 때까지 대기
2. 자식 프로세스가 종료된 상태라면 즉시 호출이 반환되며 상태를 얻고, 이때 wait() 함수는 자식 프로세스의 프로세스 ID를 반환
3. 자식 프로세스가 없다면 호출이 즉시 반환되며 에러를 반환

