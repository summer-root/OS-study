# 디스크 파일 할당

## 연속 할당과 불연속 할당

파일 시스템은 기본적으로 메인메모리 시스템과 유사하다. 전체 디스크 공간을 같은 크기로 나누고 각 공간에 주소를 붙여서 관리한다. 이때 같은 크기로 나뉜 공간 하나를 블록이라고 하는데 한 블록의 크기는 1~8KB 정도이다.

파일 시스템은 파일의 이름과 해당 파일이 시작하는 블록 주소를 가진 파일 테이블을 관리한다. 파일 테이블은 파티션 당 하나씩 존재하며 각 파티션의 맨 앞부분에 위치한다. 

일반적으로 하나의 파일은 여러 개의 블록을 사용하는데, 여러 개의 블록을 어떻게 연결하는지에 따라 다음과 같이 구분된다.

- 연속 할당 : 파일을 구성하는 데이터를 디스크상에 연속적으로 배열하는 방식이다. 연속 할당 방식에서는 파일의 시작 블록만 알면 전체 파일을 찾을 수 있으나 실제로는 사용되지 않는다. 파일을 저장하거나 삭제하다 보면 빈 공간이 생기는데, 디스크에 남는 공간 중 파일의 크기와 맞는 연속된 공간이 없을 때는 연속 할당이 불가능하기 때문이다.
- 불연속 할당 : 비어 있는 블록에 데이터를 분산하여 저장하고 이에 관한 정보를 파일 시스템이 관리하는 방식이다. 대표적인 불연속 할당 방식으로는 연결 리스트를 이용한 연결 할당과 인덱스를 이용한 인덱스 할당이 있다.

<br>



### 연결 할당

파일에 속한 데이터를 연결 리스트로 관리하는 방식이다. 파일 테이블에는 시작 블록에 대한 정보만 저장하고 나머지 데이터는 시작 블록부터 연결하여 저장한다. 파일의 맨 끝에 해당하는 블록에는 링크 대신 널을 삽입한다. 이 방식은 체인으로 연결한 것처럼 보여서 체인 할당이라고도 한다.

연결 할당 방식은 테이블 형태로 관리된다. 윈도우의 FAT가 그 예이다. FAT는 파티션 전체 블록에 대한 정보를 가진 테이블로 열의 개수가 그 파티션에 존재하는 블록의 개수와 같다. FAT에는 각 파일을 구성하는 데이터가 어떤 블록에 연결되어 있는지를 나타내는 블록 번호가 있다. 시작 블록 번호부터 FAT의 열을 따라가면 해당 파일의 전체 데이터를 알 수 있다.

FAT는 버전에 따라 FAT12, FAT16, FAT32가 있다. FAT 다음의 숫자는 파일 할당 주소의 최대 크기를 나타낸다. (ex. 2¹⁶)

테이블을 이용한 방식의 단점은 하나의 파티션이 사용할 수 있는 디스크 용량이 테이블의 주소 크기로 제한된다는 것이다. 따라서 현대 윈도우 운영체제는 64bit 주소를 지원하는 NTFS 파일 시스템을 사용하고 있다. 

<br>



### 인덱스 할당

인덱스 할당 방식에서는 테이블의 블록 포인터가 데이터 블록을 연결하는 것이 아니라 데이터의 인덱스를 담고 있는 인덱스 블록을 연결한다. 인덱스 블록은 실제 데이터의 위치에 관한 정보를 순서대로 보관하고 있다. 

인덱스 할당 방식에서 테이블이 꽉 차서 더 이상 데이터를 연결할 수 없을 때는 인덱스 블록을 연뎔하는 간접 인덱스 블록을 만들면 테이블을 무한히 확장할 수 있다. 유닉스의 I-node가 이러한 방식을 사용한다. 

I-node 테이블은 다음과 같이 구성된다.

- 파일 제어 블록: 파일 소유자와 각종 속성을 나타낸다. 파일에 대한 모든 권한의 정보를 포함하고 있기 때문에 슈퍼블록이라고도 한다.
- 블록 포인터: 데이터가 있는 블록의 위치를 직접 연결하는 포인터이다.
- 간접 포인터: 파일의 크기가 커서 블록 포인터가 다 차면 인덱스 블록을 생성한 후 간접 포인터를 생성하여 인덱스 블록을 연결한다.
- 이중/삼중 간접 포인터: 파일 크기가 커서 인덱스 블록 하나로도 다 연결할 수 없는 경우에는 이중 간접 포인터를 사용하고, 이보다 더 필요한 경우에는 삼중 간접 포인터를 사용하여 연결한다. 인덱스 블록 하나는 256개의 블록을 지정할 수 있다.

<br>



## 디스크의 빈 공간 관리

디스크는 같은 크기의 블록으로 나뉘며 블록 하나의 크기는 1~8KB 정도이다. 디스크 블록의 크기를 어떻게 정할 것인가는 메인메모리의 분할 문제와도 비슷하다. 

디스크에 파일을 저장할 때마다 모든 테이블을 뒤져 빈 공간을 찾는 것은 비효율적이다. 디스크의 내부 단편화를 줄이고 빈 공간을 효율적으로 관리하기 위해 파일 시스템은 빈 블록의 정보만 모아 놓은 빈 공간 리스트를 유지한다. 

주의할 점은 파일이 삭제되었을 때 해당 파일이 사용했던 블록의 내용을 지우지 않고 빈 공간 리스트에 삽입한다는 것이다. 파일이 사용했던 공간을 일일이 지우는 것은 시간이 많이 걸리기 때문에 파일 시스템에서는 파일 테이블의 헤더를 삭제하고 사용했던 블록을 빈 공간 리스트에 등록하는 것을 파일이 삭제된 것으로 간주한다.

하지만 이 방식은 해당 블록에 새로운 데이터를 덮어쓰지 않는 한 원래 데이터를 복구할 수 있게 된다. 또한 새로운 블록을 할당할 때는 리스트에 먼저 들어온 블록부터 할당한다. 이 특징 때문에 디스크 복구가 가능하다. 

파일 시스템 오류 복구 명령

- 윈도우: 디스크 오류 검사(chkdsk)
- 유닉스: fsck

