# 교착 상태 해결 방법

## 교착 상태 해결 방법

- 교착 상태 예방 : 교착 상태를 유발하는 네 가지 조건이 발생하지 않도록 무력화하는 방식이다. 그러나 실효성이 적어 잘 사용되지 않는다.
- 교착 상태 회피 : 자원을 할당하다가 교착 상태를 유발할 가능성이 있다고 판단되면 자원 할당을 중단하고 지켜보는 방식으로 교착 상태를 해결하는 방식이다. 그러나 자원을 얼마만큼 할당해야 교착 상태가 발생하지 않는지 알 수 없어 실효성이 적다.
- 교착 상태 검출 : 어떤 제약을 가하지 않고 자원 할당 그래프를 모니터링하며 교착 상태가 발생하는지 살펴보는 방식이다. 교착 상태가 발생하면 회복 단계가 진행된다.
- 교착 상태 회복 : 교착 상태를 해결하는 현실적인 접근 방법이다.

<br>



## 교착 상태 예방

교착 상태 예방에는 다음 네 가지 방법이 있다.

<br>



### 상호 배제 예방

시스템 내에 있는 독점적으로 사용할 수 있는 모든 자원을 없애는 방법이다. 모든 자원을 공유하는 경우 교착 상태가 발생하지 않는다. 그러나 보호해야 하는 자원이 있기 때문에 현실적으로 불가능하다.

<br>



### 비선점 예방

모든 자원을 빼앗을 수 있도록 만드는 것이다. 그러나 임계구역을 보호하기 위해 잠금을 사용하면 자원을 빼앗을 수 없을 뿐 아니라 상호 배제도 보장할 수 없기 때문에 사실상 불가능하다. 또한 해당 방법으로 인해 아사 현상이 발생할 수 있다. 아사 현상을 해결하기 위해 에이징을 사용하는 경우 해당 프로세스는 곧 비선점 자원이 되기 때문에 에이징을 사용하는 것 또한 불가능하다.

<br>



### 점유와 대기 예방

프로세스가 자원을 점유한 상태에서 다른 자원을 기다리지 못하게 하는 방법이다. 전부 할당하거나 아예 할당하지 않는 방식을 적용하는 것이다. 이를 위해 프로세스는 시작 초기에 자신이 사용하려는 모든 자원을 한꺼번에 점유하거나 그렇지 못할 경우 자원을 모두 반납해야 한다. 해당 방법은 자원을 변화시키는 것이 아닌 프로세스의 자원 사용 방식을 변화시켜 교착 상태를 처리한다. 

점유와 대기 예방의 단점

- 프로세스가 자신이 사용하는 모든 자원을 자세히 알기 어렵기 때문에 실행 이후 추가로 필요한 자원이 생기면 해당 자원의 확보가 어렵다.
- 프로세스가 미래에 사용할 자원까지 미리 선점하기 때문에 자원의 활용성이 떨어지고 낭비가 생긴다.
- 자원을 많이 사용하는 프로세스는 자원을 적게 사용하는 프로세스보다 자원 확보가 어려워 아사 현상이 발생할 수 있다.
- 점유와 대기 예방을 실제로 구현하면 거의 모든 프로세스가 일괄 작업 방식으로 처리되기 때문에 시스템의 효율이 떨어진다.

<br>



### 원형 대기 예방

점유와 대기를 하는 프로세스들이 원형을 이루지 못하도록 막는 방법으로 자원을 한 방향으로만 사용 가능하도록 설정함으로써 예방할 수 있다. 모든 자원에 숫자를 부여하고 숫자가 큰 방향으로만 자원을 할당하는 방식을 사용한다. 

원형 대기 예방의 단점

- 프로세스 작업 진행에 유연성이 떨어진다.
- 자원에 어떻게 번호를 부여할 것인지 고려해야 한다. 

<br>



## 교착 상태 회피

### 교착 상태 회피의 개념

교착 상태 회피는 프로세스에 자원을 할당할 때 어느 수준 이상의 자원을 나누어 주면 교착 상태가 발생하는지 파악하여 그 수준 이하로 자원을 나눠주는 방법이다. 교착 상태가 발생하지 않는 범위에서만 자원을 할당하고, 교착 상태가 발생하는 범위에 있으면 프로세스를 대기시킨다. 시스템의 운영 방식에 변경을 가하지 않기 때문에 교착 상태 예방보다 유연하다.

자원의 총 개수와 현재 할당된 자원의 수를 기준으로 시스템을 안정 상태와 불안정 상태로 나누고 시스템이 안정 상태를 유지하도록 자원을 할당한다. 할당된 자원이 적은 경우 안정 상태가 커지고, 할당된 자원이 늘어날수록 불안정 상태가 커진다.

![안정 상태 불안정 상태](https://github.com/summer-root/OS-study/blob/main/NEH/CHAPTER%2006%20%EA%B5%90%EC%B0%A9%20%EC%83%81%ED%83%9C/%EC%82%AC%EC%A7%84%20%EC%B2%A8%EB%B6%80/%EC%95%88%EC%A0%95%20%EC%83%81%ED%83%9C%20%EB%B6%88%EC%95%88%EC%A0%95%20%EC%83%81%ED%83%9C.png)

<br>



### 은행원 알고리즘

교착 상태 회피를 구현하는 방법 중 하나로 은행이 대출을 해 주는 방식으로 구현한다. 대출 금액이 대출 가능한 범위 내이면 허용하고, 그렇지 않으면 거부하는 방식이다. 

은행원 알고리즘은 최악의 상황을 기준으로 하며, 사용되는 변수는 다음과 같다.

- 전체 자원 : 시스템 내 전체 자원의 수
- 가용 자원 : 시스템 내 현재 사용할 수 있는 자원의 수 (= 전체 자원 - 모든 프로세스의 할당 자원)
- 최대 자원 : 각 프로세스가 선언한 최대 자원의 수
- 할당 자원 : 각 프로세스에 현재 할당된 자원의 수
- 기대 자원 : 각 프로세스가 앞으로 사용할 자원의 수 (= 최대 자원 - 할당 자원)

<br>



은행원 알고리즘에서 각 프로세스는 자신이 사용할 자원의 최대 수를 운영체제에게 알린다. 자원을 할당할 때의 기준은 다음과 같다.

- 각 프로세스의 기대 자원과 비교하여 가용 자원이 하나라도 크거나 같으면 자원을 할당한다. 
- 가용 자원이 어떤 기대 자원보다 크지 않으면 할당하지 않는다.

이에 기반해 안정 상태를 다시 정의하면 다음과 같다. 

안정 상태 : 각 프로세스의 기대 자원과 비교하여 가용 자원이 크거나 같은 경우가 한 번 이상인 경우

<br>

은행원 알고리즘에서는 현재 실행 중인 프로세스 가운데 하나라도 끝낼 수 있을 때 끝날 것이라고 예상되는 프로세스에 자원을 할당해야 한다.

<br>



### 교착 상태 회피의 문제점

- 모든 프로세스가 자신이 사용할 모든 자원을 미리 선언해야 하며, 이것이 정확해야 한다. 그렇지 않은 경우 교착 상태가 발생할 수 있다.
- 시스템의 전체 자원 수가 고장이나 추가 없이 고정적이어야 한다.
- 교착 상태가 아님에도 자원을 할당하지 않고 기다림으로써 자원이 낭비될 수 있다.

<br>



## 교착 상태 검출

### 교착 상태 검출의 개념

운영체게자 프로세스의 작업을 관찰하며 교착 상태 발생 여부를 계속 주시하는 방식으로 가장 현실적인 방법이다.

<br>



### 타임아웃을 이용한 교착 상태 검출

일정 시간 동안 작업이 진행되지 않은 프로세스를 교착 상태가 발생한 것으로 간주하여 처리하는 방법이다. 교착 상태가 자주 발생하지 않을 것이라는 가정 하에 사용되며, 쉽게 구현 가능하다. 가벼운 교착 상태 검출이라고 부른다.

 <br>



타임아웃을 이용한 교착 상태 검출의 단점

- 교착 상태가 아닌 다른 이유로 작업이 진행되지 못하는 모든 프로세스가 강제 종료될 수 있다.
- 하나의 운영체제 내에서 동작하는 프로세스의 경우 상태를 운영체제가 감시하기 때문에 적용 가능하나, 여러 군데에 데이터가 나뉘어 있고 네트워크로 연결된 시스템에서는 적용이 어렵다. 이러한 시스템에서는 원격지에 있는 프로세스의 응답이 없는 것이 교착 상태 때문인지, 네트워크 등 기타 이유 때문인지 정확히 알 수 없다.

<br>



데이터베이스의 교착 상태는 데이터의 일관성이 깨지면 안 되기 때문에 운영체제보다 처리가 복잡하다. 잠금을 얻어 데이터를 변경하는 작업을 하던 중 타임아웃으로 프로세스가 종료되면 일부 데이터에 문제가 발생할 수 있다.

타임아웃으로 데이터의 일관성이 깨지는 문제를 해결하기 위해 데이터베이스에서는 체크포인트와 롤백을 사용한다. 체크포인트는 작업을 하다가 문제가 생기면 저장된 상태로 되돌아오기 위한 표시이다. 체크포인트를 성정하면 현재의 시스템 상태가 하드디스크에 저장되는데, 이를 스냅숏이라고 한다. 롤백은 작업 중 문제가 발생하여 과거의 체크포인트로 되돌아가는 것을 말한다. 롤백이 일어나면 저장된 스냅숏을 복원하여 시스템을 체크포인트 시점으로 되돌린다.

<br>



### 자원 할당 그래프를 이용한 교착 상태 검출

자원 할당 그래프를 보면 시스탬 내의 프로세스가 어떤 자원을 사용하고 있는지 혹은 기다리고 있는지를 알 수 있다. 자원 할당 그래프에 사이클이 있는 경우 교착 상태가 발생한 것으로 간주한다. 그러나 다중 자원을 사용하는 경우에는 자원 할당 그래프에 사이클이 있다고 해서 모두 교착 상태라고 판단할 수 없다.

프로세스의 작업 방식을 제한하지 않으면서 교착 상태를 정확하게 파악할 수 있다는 것이 장점이지만, 자원 할당 그래프를 유지하고, 갱신하고, 사이클을 검사하는 추가 작업으로 인해 오버헤드가 발생하는 단점이 있다. 추가 작업을 줄이기 위해 자원이 할당될 때마다가 아닌 일정 시간마다 사이클 검사를 하는 방법도 있다.

<br>



## 교착 상태 회복

교착 상태를 유발한 프로세스를 다음 방법 중 하나로 강제 종료한다.

- 교착 상태를 일으킨 모든 프로세스를 동시에 종료 : 종료된 프로세스들이 동시에 작업을 시작하면 다시 교착 상태를 일으킬 가능성이 있으므로 순차적으로 실행해야 하며, 어떤 프로세스를 먼저 실행할 것인지에 대한 기준이 필요하다.
- 교착 상태를 일으킨 프로세스 중 하나를 골라 순서대로 종료 : 어떤 프로세스부터 종료할 것인지에 대한 다음과 같은 기준이 필요하다.
  - 우선 순위가 낮은 프로세스를 먼저 종료
  - 우선 순위가 같은 경우 작업 시간이 빠른 프로세스를 먼저 종료
  - 위의 두 조건이 같은 경우 자원을 많이 사용하는 프로세스를 먼저 종료







