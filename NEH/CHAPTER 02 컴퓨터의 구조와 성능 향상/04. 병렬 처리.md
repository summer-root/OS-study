# 병렬 처리

## 병렬 처리의 개념

병렬 처리는 동시에 여러 개의 명령을 처리하여 작업의 능률을 올리는 방식을 말한다. 병렬 처리는 코어가 여러 개인 CPU는 물론이고 하나인 CPU에서도 작동 가능하다. 

<br>



### :pencil2: CPU 멀티스레드

스레드는 CPU의 작업 단위로 한 번에 여러 개의 스레드를 처리하는 방식을 멀티 스레드라고 한다. 스레드는 운영체제가 사용하는 프로그래밍 기법을 가리키는 말이기도 하다. 

<br>



## 병렬 처리 시 고려 사항

- 상호 의존성이 없어야 병렬 처리가 가능하다. 
  각 명령이 독립적이고 앞의 결과가 뒤의 명령에 영향을 미치지 않아야 한다. 앞의 결과가 뒤의 결과에 영향을 미친다면 앞의 작업이 다 끝날 때까지 뒤의 작업을 실행할 수 없기 때문이다.
- 각 단계의 시간을 거의 일정하게 맞춰야 병렬 처리가 가능하다.
  각 단계의 처리 시간이 들쑥날쑥하면 앞의 작업이 먼저 끝나더라도 가장 긴 시간이 걸리는 단계에서 병목 현상이 발생한다. 이로 인해 진행이 전반적으로 밀려 전체 작업 시간이 늘어난다. 따라서 명렬 처리의 효과가 떨어진다.
- 전체 작업 시간을 몇 단계로 나눌지 잘 따져 보아야 한다.
  병렬 처리에서 작업을 N개로 쪼갰을 때 N을 병렬 처리의 깊이라고 한다. 병렬 처리의 깊이가 1인 경우는 병렬 처리가 없는 일반적인 작업이고, 병렬 처리의 깊이가 2인 경우는 작업을 두 단계로 나눈 것으로 동시에 처리할 수 있는 작업의 개수가 최대 2개이다. 따라서 N은 동시에 처리할 수 있는 작업의 개수를 의미한다.
  이론적으로는 N이 커질수록 동시에 작업할 수 있는 작업의 개수가 많아져 성능이 높아지나, 작업을 너무 많이 나누면 각 단계마다 작업을 이동하고 새로운 작업을 불러오는데 시간이 너무 많이 걸려 오히려 성능이 떨어진다. 이러한 오버헤드를 고려하여 보통은 병렬 처리의 깊이를 10~20 정도로 한다.

<br>



## 병렬 처리 기법

CPU 내에서 명령어는 제어장치가 처리한다. 제어장치를 명령어를 가져와 해석한 후 실행하고 결과를 저장하는 과정을 반복한다. 이 과정 전체를 하나의 스레드라고 하며, 스레드를 이루는 각 단계는 CPU의 클록과 연동되어 한 클록에 한 번씩 이루어진다.

CPU에서 명령어가 실행되는 과정은 다음과 같다.

1. 명령어 패치(Instruction Fetch, IF) : 다음에 실행할 명령어를 명령어 레지스터에 저장한다.
2. 명령어 해석(Instruction Decode, ID) : 명령어를 해석한다.
3. 실행(EXecution, EX) : 해석한 결과를 토대로 명령어를 실행한다.
4. 쓰기(Write Back, WB) : 실행된 결과를 메모리에 저장한다.

<br>



### 파이프라인 기법

파이프라인 기법은 CPU의 사용을 극대화하기 위해 명령을 겹쳐서 실행하는 방법으로 CPU의 사양과 연관지어 보면 하나의 코어에 여러 개의 스레드를 사용하는 것이다. 

파이프라인 기법에서는 명령어를 여러 단계로 분할한 후 각 단계를 동시에 처리하는 하드웨어를 독립적으로 구성한다. 기존 방식에서는 한 명령어를 처리하기 위해 명령어 처리 4단계를 모두 마치고 다음 명령어를 실행하지만, 파이프라인 기법에서는 명령어 처리의 단계마다 독립적으로 구성하여 각 단계가 쉬지 않고 명령어를 처리할 수 있게 한다. 

파이프라인 기법을 인텔 계열의 CPU에서는 하이퍼스레드라고 부른다. 하이퍼스레드는 CPU에 여러 개의 작업을 동시에 진행할 수 있는 부가장치를 만들어 하나의 코어에서도 여러 개의 작업(스레드)이 동시에 이루어지게 하는 방법이다.

파이프라인에는 파이프라인의 위험이라고 불리는 문제들이 있는데, 다음과 같다.

- 데이터 위험 : 데이터의 의존성 때문에 발생하는 문제이다. 두 번째 명령어가 첫 번째 명령어에 사용된 데이터를 필요로 하는 경우 앞의 명령어가 끝날 때까지 실행되어서는 안 된다. 데이터 위험은 파이프라인의 명령어 단계를 지연하여 해결한다.
- 제어 위험 : 프로그램의 카운터 값을 갑자기 변화시켜 발생하는 위험이다. 보통의 경우 모든 프로그램이 순차적으로 실행된다고 가정하는데, goto문으로 인해 다음 문장이 아니라 다른 문장으로 이동하는 경우 현재 동시에 처리되고 있던 명령어들이 쓸모없어진다. 제어 위험은 분기 예측이나 분기 지연 방법으로 해결한다.
- 구조 위험 : 서로 다른 명령어가 같은 자원에 접근하려고 할 때 발생하는 문제이다. 이러한 구조 위험은 해결하기 어렵다.

<br>



### 슈퍼스칼라 기법

파이프라인을 처리할 수 있는 코어를 여러 개 구성하여 복수의 명령어가 동시에 실행되도록 하는 방식이다. 대부분은 파이프라인 기법과 동일하지만 코어를 2개 구성하여 각 단계에서 동시에 실행되는 명령어가 2개라는 점이 다르다. 파이프라인 기법과 마찬가지로 슈퍼스칼라 기법에서는 처리되는 명령어가 상호 의존성 없이 독립적이어야 하며, 이를 위한 처리도 컴파일러에서 이루어지도록 조정해야 한다. 오늘날의 CPU는 대부분 슈퍼스칼라 기법을 사용하고 있다.

<br>



### 슈퍼파이프라인 기법

슈퍼파이프라인 기법은 파이프라인 기법을 강화한 것이다. 파이프라인 기법에서는 한 클록마다 하나의 명령어를 실행하지만, 슈퍼파이프라인 기법에서는 파이프라인의 각 단계를 세분화하여 한 클록 내에 여러 명령어를 처리할 수 있다. 한 클록 내에 여러 명령어를 실행하면 다음 명령어가 빠른 시간 안에 시작될 수 있어 병렬 처리 능력이 높아진다. 크레이 슈퍼 컴퓨터의 CPU에 사용된다.

<br>



### 슈퍼파이프라인 슈퍼스칼라 기법

슈퍼파이프라인 슈퍼스칼라 기법은 앞에 나온 병렬 처리 기법을 모두 합친 것이다. 슈퍼파이프라인 기법을 여러 개의 코어에서 동시에 수행하는 방식이다.

<br>



### VLIW 기법

VLIW(Very Long Instruction Word) 기법은 CPU가 병렬 처리를 지원하지 않을 경우 소프트웨어적으로 병렬 처리를 하는 방법이다. VLIW 기법에서는 동시에 수행할 수 있는 명령어들을 컴파일러가 추출하고 하나의 명령어로 압축하여 실행한다. 앞의 병렬 처리 기법들에 비해 동시에 처리하는 명령어의 개수가 적고, 컴파일 시 병렬 처리가 이루어진다.